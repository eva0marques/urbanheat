---
editor_options: 
  markdown: 
    wrap: 72
---

## Session setup

```{r}
library(data.table)
library(INLA)
library(ggplot2)
```

Source all functions

```{r}
for (f in list.files("../R", full.names = TRUE)) {
  source(f)
}
```

## Open data

#### Observations

```{r}
car <- data.table::fread("../input/car_processed_for_bhm.csv") |>
  data_bhm(temp = "temp",
           lat = "lat",
           lon = "lon",
           time = "time",
           build_h = "H_MEAN",
           build_d = "BUILD_DENS",
           dem = "alt",
           network = "car")
cws_before_qc <- data.table::fread("../input/cws_processed_for_bhm.csv") 
cws <- cws_before_qc[which(cws_before_qc$m4), ] |>
  data_bhm(temp = "temp",
           lat = "lat",
           lon = "lon",
           time = "time",
           build_h = "H_MEAN",
           build_d = "BUILD_DENS",
           dem = "alt.y",
           network = "cws")
pro <- data.table::fread("../input/mustardijon_2018010100_2018123123.csv") |>
  data_bhm(temp = "TEMP",
           lat = "LATITUDE",
           lon = "LONGITUDE",
           time = "DATE",
           build_h = "H_MEAN",
           build_d = "BUILD_DENS",
           dem = "ALTITUDE",
           network = "mustardijon")
mustard <- read.csv("../input/mustard_metadata_stations_mustardijon_clc.csv")
mustard$lcz_100m <- as.character(mustard$LCZ_100.m)
mustard$lcz_300m <- as.character(mustard$LCZ_300.m)
mustard[mustard == "101"] <- "A"
mustard[mustard == "102"] <- "B"
mustard[mustard == "103"] <- "C"
mustard[mustard == "104"] <- "D"
mustard[mustard == "105"] <- "E"
mustard[mustard == "107"] <- "G"
mustard[mustard == "9999"] <- "9"
pro <- merge(pro,
             mustard[, c("X", "Y", "lcz_100m", "lcz_300m")],
             by.x = c("lon", "lat"),
             by.y = c("X", "Y"),
             all.y = FALSE)
```

#### Dijon borders

```{r}
borders <- sf::st_read("../input/Dijon.shp") |>
  sf::st_transform(crs = "epsg:4326") 
```

#### Prediction grid

```{r}
format_pred <- function(x, lat, lon, build_h, build_d, dem){
  x <- as.data.frame(x)
  y <- x |>
    dplyr::rename("lat" = lat) |>
    dplyr::rename("lon" = lon) |>
    dplyr::rename("build_h" = build_h) |>
    dplyr::rename("build_d" = build_d) |>
    dplyr::rename("dem" = dem)
  y <- y[, c("lat", "lon", "build_h", "build_d", "dem")]
}

pred <- data.table::fread("../input/prediction_grid_mapuce_dem.csv") |>
  format_pred("lat", "lon", "H_MEAN", "BUILD_DENS", "dem")
```

#### Radome station

```{r}
rad <- read.csv("../input/radome_2018010100_2019010100_dijonlongevic.csv")
rad$DATE <- as.POSIXct(rad$DATE, tz = "UTC")
```


## Plot August 2018 scores for paper 

```{r}
scores[which(scores$rmse_joint == min(scores$rmse_joint)), ]
scores[which(scores$rmse_joint <= quantile(scores$rmse_joint, .1)), ]
scores[which(scores$n_car <= 100 & scores$rmse_joint <= .5), ]
scores[which(scores$n_car >= 3000 & scores$rsq_joint >= .8), ]
scores[which(scores$rmse_joint <= .4 & scores$rsq_joint >= .8), ]
```


```{r}
out_path <- "../output_loggamma_precintobs_sup_precint/"
ts_a <- as.POSIXct("2018-08-02 05:00:00",
                   format = "%Y-%m-%d %H:%M:%S",
                   tz = "UTC")
plots_ts_a <- plot_ts(ts_a, out_path, car, cws, pred, rad, borders)
plots_ts_a
ts_b <- as.POSIXct("2018-08-29 16:00:00",
                   format = "%Y-%m-%d %H:%M:%S",
                   tz = "UTC")
plots_ts_b <- plot_ts(ts_b, out_path, car, cws, pred, rad, borders)
plots_ts_b
plots_eval <- plot_eval(out_path)
plots_eval

```
```{r}
out_path <- "../output_loggamma_precintobs_sup_precint/"
ts_a <- as.POSIXct("2018-08-13 23:00:00",
                   format = "%Y-%m-%d %H:%M:%S",
                   tz = "UTC")
ts_b <- as.POSIXct("2018-08-02 05:00:00",
                   format = "%Y-%m-%d %H:%M:%S",
                   tz = "UTC")
save_plots_paper(ts_a,
                 ts_b,
                 out_path,
                 car,
                 cws,
                 pred,
                 rad,
                 borders)
```


Overall scores 

```{r}
overall_scores(pro_scores)
```



