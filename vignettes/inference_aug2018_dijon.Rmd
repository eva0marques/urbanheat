---
editor_options: 
  markdown: 
    wrap: 72
---

## Session setup

```{r}
library(data.table)
library(INLA)
library(ggplot2)
```

Source all functions

```{r}
source("../R/class_data_bhm.R")
source("../R/correct_altitude_gradient.R")
source("../R/run_bhm.R")
source("../R/store_post_info.R")
source("../R/evaluate_pred_vs_pro.R")
source("../R/load_palette.R")
source("../R/temperature_maps.R")
source("../R/density_plots.R")
```

## Open data

#### Observations

```{r}
car <- data.table::fread("../input/car_processed_for_bhm.csv") |>
  data_bhm(temp = "temp",
           lat = "lat",
           lon = "lon",
           time = "time",
           build_h = "H_MEAN",
           build_d = "BUILD_DENS",
           dem = "alt",
           network = "car")
cws <- data.table::fread("../input/cws_processed_for_bhm.csv")  |>
  data_bhm(temp = "temp",
           lat = "lat",
           lon = "lon",
           time = "time",
           build_h = "H_MEAN",
           build_d = "BUILD_DENS",
           dem = "alt.y",
           network = "cws")
pro <- data.table::fread("../input/mustardijon_2018010100_2018123123.csv") |>
  data_bhm(temp = "TEMP",
           lat = "LATITUDE",
           lon = "LONGITUDE",
           time = "DATE",
           build_h = "H_MEAN",
           build_d = "BUILD_DENS",
           dem = "ALTITUDE",
           network = "mustardijon")
mustard <- read.csv("../input/mustard_metadata_stations_mustardijon_clc.csv")
mustard$lcz_100m <- as.character(mustard$LCZ_100.m)
mustard$lcz_300m <- as.character(mustard$LCZ_300.m)
mustard[mustard == "101"] <- "A"
mustard[mustard == "102"] <- "B"
mustard[mustard == "103"] <- "C"
mustard[mustard == "104"] <- "D"
mustard[mustard == "105"] <- "E"
mustard[mustard == "107"] <- "G"
mustard[mustard == "9999"] <- "9"
pro <- merge(pro,
             mustard[, c("X", "Y", "lcz_100m", "lcz_300m")],
             by.x = c("lon", "lat"),
             by.y = c("X", "Y"),
             all.y = FALSE)
```

#### Dijon borders

```{r}
borders <- sf::st_read("../input/Dijon.shp") |>
  sf::st_transform(crs = "epsg:4326") 
```

#### Prediction grid

```{r}
format_pred <- function(x, lat, lon, build_h, build_d, dem){
  x <- as.data.frame(x)
  y <- x |>
    dplyr::rename("lat" = lat) |>
    dplyr::rename("lon" = lon) |>
    dplyr::rename("build_h" = build_h) |>
    dplyr::rename("build_d" = build_d) |>
    dplyr::rename("dem" = dem)
  y <- y[, c("lat", "lon", "build_h", "build_d", "dem")]
}

pred <- data.table::fread("../input/prediction_grid_mapuce_dem.csv") |>
  format_pred("lat", "lon", "H_MEAN", "BUILD_DENS", "dem")
```

#### Radome station 

```{r}
rad <- read.csv("../input/radome_2018010100_2019010100_dijonlongevic.csv")
rad$DATE <- as.POSIXct(rad$DATE, tz = "UTC")
```

## Run model on 1 hour

```{r}
ts <- as.POSIXct("2018-08-02 05:00:00", tz = "UTC")
sw <- rad[which(rad$DATE == ts), "GLO"]
temp_reg <- rad[which(rad$DATE == ts), "T"]
test <- run_bhm(car = car,
                cws = cws,
                pred = pred,
                ts = ts,
                sw = sw,
                temp_reg = temp_reg,
                borders = borders)
test$info <- store_post_info(test$mod_joint, test$info)
summary(test$mod_joint)
summary(test$mod_car)
summary(test$mod_cws)
eval <- evaluate_pred(test$pred, pro, info = test$info, borders)
eval 
```

Plot 1 hour results

```{r}
map_pred_mean(test$pred, eval$pro, borders, "temp_sea", "car")
map_pred_mean(test$pred, eval$pro, borders, "temp_sea", "cws")
map_pred_mean(test$pred, eval$pro, borders, "temp_sea", "joint")
map_pred_sd(test$pred, borders, "joint")
map_obs(car, cws, ts = unique(test$pred$time), borders, y_var = "temp_sea")
density_obs_intercept(test$info)
density_hyperprec(test$mod_joint, test$info)
density_beta_covar(test$info)
plot_predmean_vs_ref(eval$pro, "temp_sea", "joint")
plot_res_vs_ref(eval$pro, "temp_sea", "joint")
```

Plot residuals analysis

```{r}
map_median_res(eval$pro, borders)
```

## Run model on Dijon - Aug 2018

Pb at 2018082000 and 2018083100: no data?

```{r}
set.seed(12)
t_start <- as.POSIXct("2018-08-01 00:00:00", tz = "UTC")
t_end <- as.POSIXct("2018-08-31 23:00:00", tz = "UTC")
period <- seq(t_start, t_end, by = "1 hour")
for (p in period) {
  p_str <- strftime(p, format = "%Y-%m-%d %H:%M:%S", tz = "UTC") |>
    as.POSIXct(tz = "UTC")
  sw <- rad[which(rad$DATE == p_str), "GLO"]
  temp_reg <- rad[which(rad$DATE == p_str), "T"]
  inference <- run_bhm(
    car = car,
    cws = cws,
    pred = pred,
    ts = p_str,
    sw = sw,
    temp_reg = temp_reg,
    borders = borders
  )
  if (is.null(inference)) {
    next
  } else {
    saveRDS(
      object = inference$pred,
      file = paste0(
        "../output4/pred_",
        format(p_str, "%Y%m%d%H"),
        ".rds"
      )
    )
    inference$info <- store_post_info(
      inference$mod_joint,
      inference$info
    )
    eval <- evaluate_pred(inference$pred,
      pro,
      info = inference$info,
      borders
    )
    file <- "../output4/scores_201808_dijon.csv"
		write.table(eval$scores,
		            file,
		            append = TRUE,
		            sep = ",",
		            col.names = !file.exists(file),
		            row.names = FALSE,
		            quote = FALSE)
		file <- "../output4/mustard_evaluation_201808_dijon.csv"
		pro_eval <- as.data.frame(eval$pro)
		pro_eval$geometry <- NULL
		write.table(pro_eval,
		            file, 
		            append = TRUE,
		            sep = ",",
		            col.names = !file.exists(file),
		            row.names = FALSE,
		            quote = FALSE)
  }
}
```

Read scores

```{r}
aug_scores <- read.csv("../output4/scores_201808_dijon.csv")
pro_scores <- read.csv("../output4/mustard_evaluation_201808_dijon.csv")
```

## Plot August scores

```{r}
p <- ggplot2::ggplot(
    x,
    aes(
      y = as.Date(time),
      x = lubridate::hour(time),
      fill = rmse_joint
    )
  ) +
    geom_tile() +
    scale_fill_stepsn(colours = c("white", "firebrick4"),
                      breaks = seq(0, 2, .2),
                      limits = c(0, 2)) +
    labs(
      x = "hour",
      y = "date"
    ) +
    scale_y_date(
      date_labels = "%m-%d",
      date_breaks = "3 days",
      date_minor_breaks = "1 day"
    ) +
    #guides(fill = guide_colourbar(barwidth = 0.7, barheight = 25)) +
    theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey"),
      panel.grid.minor = element_line(colour = "azure2"),
      legend.position = "right"
    )
p
```

```{r}
ggplot(x) +
  geom_line(aes(x = time, y = rmse_car), color = "red") +
  geom_line(aes(x = time, y = rmse_cws), color = "blue") +
  geom_line(aes(x = time, y = rmse_joint), color = "cyan") 
```
